<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>rego-cpp: Rego Bundle Binary Format</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="regocpp-logo-48.png"/></td>
  <td id="projectalign">
   <div id="projectname">rego-cpp<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">A C++ implementation of the Rego language and runtime</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Rego Bundle Binary Format</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_binary"></a></p>
<p>The OPA standard for bundles is a JSON document, as described in the <a href="https://www.openpolicyagent.org/docs/ir">IR documentation</a>. However, this JSON can be bulky and quite cumbersome to parse. We have designed a binary format which is more lightweight while retaining the same information and basic layout. The pseudo-BNF grammar below describes the format. This format is implemented in <a href="src/bundle_binary.cc"><code>bundle_binary.cc</code></a>.</p>
<h1><a class="anchor" id="autotoc_md16"></a>
Basic Types</h1>
<p>The following basic types are used as terminals in the rest of the grammar. Each type must be serialised in little-endian format.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"></th><th class="markdownTableHeadNone"></th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>byte</code>   </td><td class="markdownTableBodyNone">1 byte (8-bits)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>signed_byte(n)</code>   </td><td class="markdownTableBodyNone">8-bit, two's complement signed integer for which the value is n    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>unsigned_byte(n)</code>   </td><td class="markdownTableBodyNone">8-bit unsigned integer for which the value is n    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>uint16</code>   </td><td class="markdownTableBodyNone">2 bytes (16-bit unsigned integer)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>int32</code>   </td><td class="markdownTableBodyNone">4 bytes (32-bit signed integer, two's complement)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>uint32</code>   </td><td class="markdownTableBodyNone">4 bytes (32-bit unsigned integer)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>int64</code>   </td><td class="markdownTableBodyNone">8 bytes (64-bit signed integer, two's complement)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>uint64</code>   </td><td class="markdownTableBodyNone">8 bytes (64-bit unsigned integer)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>double</code>   </td><td class="markdownTableBodyNone">8 bytes (64-bit IEEE 754-2008 binary floating point)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>decimal128</code>   </td><td class="markdownTableBodyNone">16 bytes (128-bit IEEE 754-2008 decimal floating point)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>hex(s)</code>   </td><td class="markdownTableBodyNone">raw binary sequence that matches s    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>loc(id)</code>   </td><td class="markdownTableBodyNone"><code>uint64</code> location of non-terminal <code>id</code> in the bundle    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>bson</code>   </td><td class="markdownTableBodyNone">a <a href="https://bsonspec.org/spec.html">BSON</a> document    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>local</code>   </td><td class="markdownTableBodyNone">4 bytes (32-bit unsigned integer) local index   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md17"></a>
Grammar</h1>
<p>The following specifies the rest of the grammar. Note that we use the * operator as shorthand for repetition (e.g. (<code>byte*2</code>) is <code>byte byte</code>). When used as a unary operator, * means that the repetition can occur 0 or more times. We will begin with a pseudo-BNF description of the overall format, and then will provide additional details on the <code>header</code> token. Some notes for reading the grammar:</p>
<ul>
<li>In most cases, the context is given as a comment in the grammar where needed</li>
<li>Unless otherwise specified, a <code>uint*</code> before a <code>*_list</code> token is the number of tokens in that list</li>
<li>The <code>table</code> token in <code>plans</code> and <code>functions</code> gives the locations of individual plans and functions in the file.</li>
</ul>
<div class="fragment"><div class="line">bundle ::= header static plans funcs data</div>
<div class="line">header ::= hex(0x5245474F42554E) uint8*8 uint32 uint32 uint64 loc(static) loc(plans) loc(funcs) loc(data)</div>
<div class="line">bundle_crc32 ::= uint32</div>
<div class="line">static ::= signed_byte(1) files strings builtin_funcs query</div>
<div class="line">strings ::= uint32 loc_list</div>
<div class="line">builtin_funcs ::= uint32 bf_list</div>
<div class="line">query ::= signed_byte(1)                                                        # Undefined</div>
<div class="line">          signed_byte(2) string                                                 # Query string</div>
<div class="line">bf_list ::= builtin_func bf_list | &quot;&quot;</div>
<div class="line">builtin_func ::= string builtin_decl                                            # name of function, decl</div>
<div class="line">builtin_decl ::= builtin_args builtin_return</div>
<div class="line">builtin_args ::= signed_byte(1)                                                 # Var args</div>
<div class="line">               | signed_byte(2) uint8 ba_list</div>
<div class="line">ba_list ::= builtin_arg ba_list | &quot;&quot;</div>
<div class="line">builtin_result ::= signed_byte(1)                                               # Void</div>
<div class="line">                   signed_byte(2) string string builtin_type</div>
<div class="line">builtin_arg ::= string string builtin_type                                      # name, description, type</div>
<div class="line">builtin_type ::= signed_byte(1)                                                 # Any</div>
<div class="line">               | signed_byte(2)                                                 # Number</div>
<div class="line">               | signed_byte(3)                                                 # String</div>
<div class="line">               | signed_byte(4)                                                 # Boolean</div>
<div class="line">               | signed_byte(5)                                                 # Null</div>
<div class="line">               | signed_byte(6) builtin_type                                    # Array (dynamic)</div>
<div class="line">               | signed_byte(7) byte bt_list                                    # Array (static)</div>
<div class="line">               | signed_byte(8) builtin_type builtin_type                       # Object (dynamic)</div>
<div class="line">               | signed_byte(9) byte bkv_list                                   # Object (static)</div>
<div class="line">               | signed_byte(10) builtin_type builtin_type byte bkv_list        # Object (hybrid)</div>
<div class="line">               | signed_byte(11) builtin_type                                   # Set</div>
<div class="line">               | signed_byte(12) byte bt_list                                   # TypeSeq</div>
<div class="line">bt_list ::= builtin_type bt_list | &quot;&quot;</div>
<div class="line">bkv_list ::= builtin_type builtin_type bkv_list | &quot;&quot;</div>
<div class="line">files ::= uint32 f_list</div>
<div class="line">f_list ::= file f_list | &quot;&quot;</div>
<div class="line">file ::= string string                                                          # name, contents</div>
<div class="line">str_list ::= string str_list | &quot;&quot;</div>
<div class="line">string ::= uint32 byte*</div>
<div class="line">plans ::= signed_byte(2) uint32 p_list table</div>
<div class="line">table ::= uint64 uint32 loc_list</div>
<div class="line">loc_list ::= loc_index loc_list | &quot;&quot;</div>
<div class="line">loc_index ::= string uint64                                                     # name of item, location in file</div>
<div class="line">p_list ::= plan p_list | &quot;&quot;</div>
<div class="line">plan ::= string blocks                                                          # name, blocks</div>
<div class="line">blocks ::= uint32 b_list</div>
<div class="line">b_list ::= block b_list | &quot;&quot;</div>
<div class="line">block ::= uint32 s_list</div>
<div class="line">s_list ::= statement s_list | &quot;&quot;</div>
<div class="line">statement ::= signed_byte(1) source local operand                               # ArrayAppendStmt(array, value)</div>
<div class="line">            | signed_byte(2) source int64 local                                 # AssignIntStmt(value, target)</div>
<div class="line">            | signed_byte(3) source operand local                               # AssignVarOnceStmt(source, target)</div>
<div class="line">            | signed_byte(4) source operand local                               # AssignVarStmt(source, target)</div>
<div class="line">            | signed_byte(5) source blocks                                      # BlockStmt(blocks)</div>
<div class="line">            | signed_byte(6) source uint32                                      # BreakStmt(index)</div>
<div class="line">            | signed_byte(7) source operands operands local                     # CallDynamicStmt(path, args, result)</div>
<div class="line">            | signed_byte(8) source string operands local                       # CallStmt(func, args, result)</div>
<div class="line">            | signed_byte(9) source operand operand local                       # DotStmt(source, key, target)</div>
<div class="line">            | signed_byte(10) source operand operand                            # EqualStmt(a, b)</div>
<div class="line">            | signed_byte(11) source operand                                    # IsArrayStmt(source)</div>
<div class="line">            | signed_byte(12) source local                                      # IsDefinedStmt(source)</div>
<div class="line">            | signed_byte(13) source operand                                    # IsObjectStmt(source)</div>
<div class="line">            | signed_byte(14) source operand                                    # IsSetStmt(source)</div>
<div class="line">            | signed_byte(15) source local                                      # IsUndefinedStmt(source)</div>
<div class="line">            | signed_byte(16) source operand local                              # LenStmt(source, target)</div>
<div class="line">            | signed_byte(17) source int32 local                                # MakeArrayStmt(capacity, target)</div>
<div class="line">            | signed_byte(18) source local                                      # MakeNullStmt(target)</div>
<div class="line">            | signed_byte(19) source int64 local                                # MakeNumberIntStmt(value, target)</div>
<div class="line">            | signed_byte(20) source int32 local                                # MakeNumberRefStmt(index, target)</div>
<div class="line">            | signed_byte(21) source local                                      # MakeObjectStmt(target)</div>
<div class="line">            | signed_byte(22) source local                                      # MakeSetStmt(target)</div>
<div class="line">            | signed_byte(23) source operand operand                            # NotEqualStmt(a, b)</div>
<div class="line">            | signed_byte(24) source block                                      # NotStmt(block)</div>
<div class="line">            | signed_byte(25) source operand operand local                      # ObjectInsertOnceStmt(key, value, object)</div>
<div class="line">            | signed_byte(26) source operand operand local                      # ObjectInsertStmt(key, value, object)</div>
<div class="line">            | signed_byte(27) source local local local                          # ObjectMergeStmt(a, b, target)</div>
<div class="line">            | signed_byte(28) source local                                      # ResetLocalStmt(target)</div>
<div class="line">            | signed_byte(29) source local                                      # ResultSetAddStmt(value)</div>
<div class="line">            | signed_byte(30) source local                                      # ReturnLocalStmt(source)</div>
<div class="line">            | signed_byte(31) source local local local block                    # ScanStmt(source, key, value, block)</div>
<div class="line">            | signed_byte(32) source operand local                              # SetAddStmt(value, set)</div>
<div class="line">            | signed_byte(33) source local ipath operand block                  # WithStmt(local, path, value, block)</div>
<div class="line">source ::= signed_byte(1)                                                       # no source</div>
<div class="line">         | signed_byte(2) uint32 uint32 uint32                                  # file index, position in file, length of string</div>
<div class="line">operand ::= signed_byte(1) local                                                # local</div>
<div class="line">            signed_byte(2) uint32                                               # string index</div>
<div class="line">            signed_byte(3)                                                      # boolean (true)</div>
<div class="line">            signed_byte(4)                                                      # boolean (false)</div>
<div class="line">operands ::= uint8 o_list</div>
<div class="line">ipath ::= uint8 i32_list</div>
<div class="line">i32_list ::= int32 i32_list | &quot;&quot;</div>
<div class="line">o_list ::= operand o_list | &quot;&quot;</div>
<div class="line">funcs ::= signed_byte(3) uint32 f_list table</div>
<div class="line">f_list ::= function f_list | &quot;&quot;</div>
<div class="line">function ::= string path params local blocks                                    # name, dynamic path, parameters, return, blocks</div>
<div class="line">path ::= uint8 str_list</div>
<div class="line">params ::= uint8 id_list</div>
<div class="line">id_list ::= local id_list | &quot;&quot;</div>
<div class="line">data ::= signed_byte(4) bson</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md18"></a>
<code>header</code></h2>
<p>The header consists of the following elements:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Token   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Magic Word   </td><td class="markdownTableBodyNone">byte*8   </td><td class="markdownTableBodyNone"><code>REGOBUND</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Rego Version   </td><td class="markdownTableBodyNone">byte   </td><td class="markdownTableBodyNone">The major version of Rego required to execute the bundle.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Rego Binary Version   </td><td class="markdownTableBodyNone">byte   </td><td class="markdownTableBodyNone">The version of the Rego Binary format used to encode the file    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Query Plan Index   </td><td class="markdownTableBodyNone">sbyte   </td><td class="markdownTableBodyNone">The index of the plan that represents the query. -1 if no query was compiled.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Reserved   </td><td class="markdownTableBodyNone">5 * byte   </td><td class="markdownTableBodyNone">Reserved header bytes    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Local Count   </td><td class="markdownTableBodyNone">uint32   </td><td class="markdownTableBodyNone">Number of locals variables in the program.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CRC32   </td><td class="markdownTableBodyNone">uint32   </td><td class="markdownTableBodyNone">CRC32 of everything after the header    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Size   </td><td class="markdownTableBodyNone">uint64   </td><td class="markdownTableBodyNone">Size of the bundle file (not including the header)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>loc([token])</code>   </td><td class="markdownTableBodyNone">uint64   </td><td class="markdownTableBodyNone">Location of <code>token</code> within the file as number of bytes from the start.   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
